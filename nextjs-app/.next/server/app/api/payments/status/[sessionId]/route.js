"use strict";(()=>{var e={};e.id=586,e.ids=[586],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},32054:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>x,patchFetch:()=>f,requestAsyncStorage:()=>_,routeModule:()=>l,serverHooks:()=>y,staticGenerationAsyncStorage:()=>m});var r={};s.r(r),s.d(r,{GET:()=>c});var n=s(49303),a=s(88716),i=s(60670),o=s(87070),u=s(90455),p=s(26039),d=s(69206);async function c(e,{params:t}){try{if(!await (0,u.ts)(e))return o.NextResponse.json({detail:"Not authenticated"},{status:401});let s=await (0,p.z)(),r=await s.collection("payment_transactions").findOne({session_id:t.sessionId},{projection:{_id:0}});if(!r)return o.NextResponse.json({detail:"Transaction not found"},{status:404});if("paid"===r.payment_status)return o.NextResponse.json({status:"paid",order_id:r.order_id});let n=await (0,d.Gx)(t.sessionId);return"paid"===n.payment_status&&"paid"!==r.payment_status&&(await s.collection("payment_transactions").updateOne({session_id:t.sessionId},{$set:{payment_status:"paid",updated_at:new Date().toISOString()}}),await s.collection("orders").updateOne({id:r.order_id},{$set:{payment_status:"paid",order_status:"confirmed"}}),await s.collection("carts").updateOne({user_id:r.user_id},{$set:{items:[],updated_at:new Date().toISOString()}})),o.NextResponse.json({status:n.payment_status,order_id:r.order_id})}catch(e){return console.error("Get payment status error:",e),o.NextResponse.json({detail:"Failed to get payment status"},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/payments/status/[sessionId]/route",pathname:"/api/payments/status/[sessionId]",filename:"route",bundlePath:"app/api/payments/status/[sessionId]/route"},resolvedPagePath:"/app/nextjs-app/app/api/payments/status/[sessionId]/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:m,serverHooks:y}=l,x="/api/payments/status/[sessionId]/route";function f(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:m})}},90455:(e,t,s)=>{s.d(t,{V3:()=>o,ts:()=>u});var r=s(41482),n=s.n(r),a=s(26039);let i=process.env.JWT_SECRET||"jungle-swimwear-secret-key-2024";function o(e,t){return n().sign({user_id:e,email:t},i,{expiresIn:"30d"})}async function u(e){let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return null;let s=function(e){try{return n().verify(e,i)}catch{return null}}(t.split(" ")[1]);if(!s)return null;let r=await (0,a.z)();return await r.collection("users").findOne({id:s.user_id},{projection:{_id:0,password:0}})}},26039:(e,t,s)=>{let r;s.d(t,{z:()=>i});let n=require("mongodb");if(!process.env.MONGODB_URI)throw Error("Please add your Mongo URI to .env.local");let a=process.env.MONGODB_URI;async function i(){return(await r).db(process.env.DB_NAME)}r=new n.MongoClient(a,{}).connect()},69206:(e,t,s)=>{s.d(t,{Gx:()=>i,Mc:()=>a});var r=s(48472);if(!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is not set");let n=new r.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-12-18.acacia"});async function a({amount:e,currency:t="usd",successUrl:s,cancelUrl:r,metadata:a}){return await n.checkout.sessions.create({payment_method_types:["card"],line_items:[{price_data:{currency:t,unit_amount:Math.round(100*e),product_data:{name:"Commande Jungle Chic"}},quantity:1}],mode:"payment",success_url:s,cancel_url:r,metadata:a})}async function i(e){return await n.checkout.sessions.retrieve(e)}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[276,972,482,472],()=>s(32054));module.exports=r})();