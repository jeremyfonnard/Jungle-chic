"use strict";(()=>{var e={};e.id=723,e.ids=[723],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},96459:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>_,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{POST:()=>l});var s=r(49303),a=r(88716),o=r(60670),i=r(87070),u=r(90455),c=r(26039),d=r(69206),p=r(46335);async function l(e){try{let t=await (0,u.ts)(e);if(!t)return i.NextResponse.json({detail:"Not authenticated"},{status:401});let{order_id:r,origin_url:n}=await e.json(),s=await (0,c.z)(),a=await s.collection("orders").findOne({id:r,user_id:t.id});if(!a)return i.NextResponse.json({detail:"Order not found"},{status:404});if("paid"===a.payment_status)return i.NextResponse.json({detail:"Order already paid"},{status:400});let o=`${n}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,l=`${n}/checkout/cancel`,m=await (0,d.Mc)({amount:a.total_amount,currency:"usd",successUrl:o,cancelUrl:l,metadata:{order_id:r,user_id:t.id,user_email:t.email}}),_={id:(0,p.Z)(),session_id:m.id,user_id:t.id,order_id:r,amount:a.total_amount,currency:"usd",payment_status:"pending",metadata:{order_id:r,user_id:t.id,user_email:t.email},created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return await s.collection("payment_transactions").insertOne(_),await s.collection("orders").updateOne({id:r},{$set:{stripe_session_id:m.id}}),i.NextResponse.json({url:m.url,session_id:m.id})}catch(e){return console.error("Create checkout error:",e),i.NextResponse.json({detail:"Failed to create checkout session"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/payments/checkout/route",pathname:"/api/payments/checkout",filename:"route",bundlePath:"app/api/payments/checkout/route"},resolvedPagePath:"/app/nextjs-app/app/api/payments/checkout/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:f}=m,y="/api/payments/checkout/route";function w(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},90455:(e,t,r)=>{r.d(t,{V3:()=>i,ts:()=>u});var n=r(41482),s=r.n(n),a=r(26039);let o=process.env.JWT_SECRET||"jungle-swimwear-secret-key-2024";function i(e,t){return s().sign({user_id:e,email:t},o,{expiresIn:"30d"})}async function u(e){let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return null;let r=function(e){try{return s().verify(e,o)}catch{return null}}(t.split(" ")[1]);if(!r)return null;let n=await (0,a.z)();return await n.collection("users").findOne({id:r.user_id},{projection:{_id:0,password:0}})}},26039:(e,t,r)=>{let n;r.d(t,{z:()=>o});let s=require("mongodb");if(!process.env.MONGODB_URI)throw Error("Please add your Mongo URI to .env.local");let a=process.env.MONGODB_URI;async function o(){return(await n).db(process.env.DB_NAME)}n=new s.MongoClient(a,{}).connect()},69206:(e,t,r)=>{r.d(t,{Gx:()=>o,Mc:()=>a});var n=r(48472);if(!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is not set");let s=new n.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-12-18.acacia"});async function a({amount:e,currency:t="usd",successUrl:r,cancelUrl:n,metadata:a}){return await s.checkout.sessions.create({payment_method_types:["card"],line_items:[{price_data:{currency:t,unit_amount:Math.round(100*e),product_data:{name:"Commande Jungle Chic"}},quantity:1}],mode:"payment",success_url:r,cancel_url:n,metadata:a})}async function o(e){return await s.checkout.sessions.retrieve(e)}},46335:(e,t,r)=>{r.d(t,{Z:()=>u});let n=require("node:crypto"),s={randomUUID:n.randomUUID},a=new Uint8Array(256),o=a.length,i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));let u=function(e,t,r){return!s.randomUUID||t||e?function(e,t,r){let s=(e=e||{}).random??e.rng?.()??(o>a.length-16&&((0,n.randomFillSync)(a),o=0),a.slice(o,o+=16));if(s.length<16)throw Error("Random bytes length must be >= 16");if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=s[e];return t}return function(e,t=0){return(i[e[t+0]]+i[e[t+1]]+i[e[t+2]]+i[e[t+3]]+"-"+i[e[t+4]]+i[e[t+5]]+"-"+i[e[t+6]]+i[e[t+7]]+"-"+i[e[t+8]]+i[e[t+9]]+"-"+i[e[t+10]]+i[e[t+11]]+i[e[t+12]]+i[e[t+13]]+i[e[t+14]]+i[e[t+15]]).toLowerCase()}(s)}(e,t,r):s.randomUUID()}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,972,482,472],()=>r(96459));module.exports=n})();